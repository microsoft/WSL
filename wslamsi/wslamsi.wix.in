<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
    <Package Name="WSL For Apps" Language="1033" InstallerVersion="500" Version="${PACKAGE_VERSION}" Manufacturer="Microsoft Corporation" UpgradeCode="6A4F9463-A9C4-4C00-9634-88C41F915FF6" Scope="perMachine" Compressed="${COMPRESS_PACKAGE}">
        <MajorUpgrade AllowDowngrades="yes"  Disallow="no"  />
        <MediaTemplate EmbedCab="yes" />

        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLDIR" Name="WSLA">
                <Directory Id="TOOLSFOLDER" Name="tools" />
                <Directory Id="LIBFOLDER" Name="lib" />
            </Directory>
        </StandardDirectory>

        <Icon Id="wsl.ico" SourceFile="${CMAKE_SOURCE_DIR}/images/wsl.ico"/>
        <Property Id="ARPPRODUCTICON" Value="wsl.ico"/>

        <DirectoryRef Id="INSTALLDIR">
            <Component Id="wslaservice" Guid="DC97520E-BFA5-4559-960F-D580E151629F" UninstallWhenSuperseded="yes" DisableRegistryReflection="yes" Bitness="always64">
                <!-- Installation data -->
                <RegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\WSLA\MSI">
                    <RegistryValue Name="InstallLocation" Value="[INSTALLDIR]" Type="string" />
                    <RegistryValue Name="ProductCode" Value="[ProductCode]" Type="string" />
                    <RegistryValue Name="Version" Value="${PACKAGE_VERSION}" Type="string" />
                </RegistryKey>

                <!-- WSLAServiceProxyStub. -->
                <RegistryKey Root="HKCR" Key="CLSID\{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}">
                    <RegistryValue Value="PSFactoryBuffer" Type="string" />
                    <RegistryKey Key="InProcServer32">
                        <RegistryValue Value="[INSTALLDIR]wslaserviceproxystub.dll" Type="string" />
                        <RegistryValue Name="ThreadingModel" Value="Both" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- WSLAService COM app -->
                <RegistryKey Root="HKCR" Key="AppID\{E9B79997-57E3-4201-AECC-6A464E530DD2}">

                    <!-- O:BAG:BAD:(A;;CCDCSW;;;AU)(A;;CCDCSW;;;PS)(A;;CCDCSW;;;SY) -->
                    <RegistryValue Name="AccessPermission" Value="01000480580000006800000000000000140000000200440003000000000014000B00000001010000000000050B000000000014000B00000001010000000000050A000000000014000B0000000101000000000005120000000102000000000005200000002002000001020000000000052000000020020000" Type="binary" />
                    <RegistryValue Name="LaunchPermission" Value="01000480580000006800000000000000140000000200440003000000000014000B00000001010000000000050B000000000014000B00000001010000000000050A000000000014000B0000000101000000000005120000000102000000000005200000002002000001020000000000052000000020020000" Type="binary" />
                    <RegistryValue Name="LocalService" Value="WSLAService" Type="string" />
                </RegistryKey>

                <!-- WSLAContainer -->
                <RegistryKey Root="HKCR" Key="CLSID\{B1F1C4E3-C225-4CAE-AD8A-34C004DE1AE4}">
                    <RegistryValue Name="AppId" Value="{E9B79997-57E3-4201-AECC-6A464E530DD2}" Type="string" />
                    <RegistryValue Value="WSLAContainer" Type="string" />
                </RegistryKey>

                <!-- WSLAProcess -->
                <RegistryKey Root="HKCR" Key="CLSID\{AFBEA6D6-D8A4-4F81-8FED-F947EB74B33B}">
                    <RegistryValue Name="AppId" Value="{E9B79997-57E3-4201-AECC-6A464E530DD2}" Type="string" />
                    <RegistryValue Value="WSLAProcess" Type="string" />
                </RegistryKey>

                <!-- WSLAUserSession -->
                <RegistryKey Root="HKCR" Key="CLSID\{A9B7A1B9-0671-405C-95F1-E0612CB4CE8F}">
                    <RegistryValue Name="AppId" Value="{E9B79997-57E3-4201-AECC-6A464E530DD2}" Type="string" />
                    <RegistryValue Value="WSLAUserSession" Type="string" />
                </RegistryKey>

                <!-- WSLAVirtualMachine -->
                <RegistryKey Root="HKCR" Key="CLSID\{0CFC5DC1-B6A7-45FC-8034-3FA9ED73CE30}">
                    <RegistryValue Name="AppId" Value="{E9B79997-57E3-4201-AECC-6A464E530DD2}" Type="string" />
                    <RegistryValue Value="WSLAVirtualMachine" Type="string" />
                </RegistryKey>
                <!-- WSLASession -->
                <RegistryKey Root="HKCR" Key="CLSID\{4877FEFC-4977-4929-A958-9F36AA1892A4}">
                    <RegistryValue Name="AppId" Value="{E9B79997-57E3-4201-AECC-6A464E530DD2}" Type="string" />
                    <RegistryValue Value="WSLASession" Type="string" />
                </RegistryKey>

                <!-- IWSLAUserSession-->
                <RegistryKey Root="HKCR" Key="Interface\{82A7ABC8-6B50-43FC-AB96-15FBBE7E8760}">
                    <RegistryValue Value="IWSLAUserSession" Type="string" />
                    <RegistryKey Key="ProxyStubClsid32">
                        <RegistryValue Value="{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- IWSLAVirtualMachine-->
                <RegistryKey Root="HKCR" Key="Interface\{82A7ABC8-6B50-43FC-AB96-15FBBE7E8761}">
                    <RegistryValue Value="IWSLAVirtualMachine" Type="string" />
                    <RegistryKey Key="ProxyStubClsid32">
                        <RegistryValue Value="{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- IWSLAContainer-->
                <RegistryKey Root="HKCR" Key="Interface\{7577FE8D-DE85-471E-B870-11669986F332}">
                    <RegistryValue Value="IWSLAContainer" Type="string" />
                    <RegistryKey Key="ProxyStubClsid32">
                        <RegistryValue Value="{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- IWSLAProcess-->
                <RegistryKey Root="HKCR" Key="Interface\{1AD163CD-393D-4B33-83A2-8A3F3F23E608}">
                    <RegistryValue Value="IWSLAProcess" Type="string" />
                    <RegistryKey Key="ProxyStubClsid32">
                        <RegistryValue Value="{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- ITerminationCallback-->
                <RegistryKey Root="HKCR" Key="Interface\{7BC4E198-6531-4FA6-ADE2-5EF3D2A04DFE}">
                    <RegistryValue Value="ITerminationCallback" Type="string" />
                    <RegistryKey Key="ProxyStubClsid32">
                        <RegistryValue Value="{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- IProgressCallback-->
                <RegistryKey Root="HKCR" Key="Interface\{5038842F-53DB-4F30-A6D0-A41B02C94AC1}">
                    <RegistryValue Value="IProgressCallback" Type="string" />
                    <RegistryKey Key="ProxyStubClsid32">
                        <RegistryValue Value="{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- IWSLASession-->
                <RegistryKey Root="HKCR" Key="Interface\{EF0661E4-6364-40EA-B433-E2FDF11F3519}">
                    <RegistryValue Value="IWSLASession" Type="string" />
                    <RegistryKey Key="ProxyStubClsid32">
                        <RegistryValue Value="{4EA0C6DD-E9FF-48E7-994E-13A31D10DC61}" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- wsldevicehost.dll -->
                <!-- TODO: WSL currently has two AppID registrations for wsldevicehost, is that needed? -->
                <RegistryKey Root="HKCR" Key="AppID\{C457EA11-5486-4174-B90D-089909EDB170}">
                    <RegistryValue Name="DllSurrogate" Value="" Type="string" />
                    <RegistryValue Name="AppIDFlags" Value="2048" Type="integer" />

                    <!-- O:BAG:BAD:(A;;CCDCSW;;;AU)(A;;CCDCSW;;;PS)(A;;CCDCSW;;;SY) -->
                    <RegistryValue Name="AccessPermission" Value="01000480580000006800000000000000140000000200440003000000000014000B00000001010000000000050B000000000014000B00000001010000000000050A000000000014000B0000000101000000000005120000000102000000000005200000002002000001020000000000052000000020020000" Type="binary" />
                    <RegistryValue Name="LaunchPermission" Value="01000480580000006800000000000000140000000200440003000000000014000B00000001010000000000050B000000000014000B00000001010000000000050A000000000014000B0000000101000000000005120000000102000000000005200000002002000001020000000000052000000020020000" Type="binary" />
                </RegistryKey>

                <!-- WslDeviceHost WSLA_VIRTIO_FS_ADMIN_CLASS_ID -->
                <RegistryKey Root="HKCR" Key="CLSID\{8F7C2A3B-D9E4-4C1F-A2B8-5E3D7C9F1A6E}">
                    <RegistryValue Value="WslDeviceHost_VirtioFsAdmin" Type="string" />
                    <RegistryValue Name="AppId" Value="{C457EA11-5486-4174-B90D-089909EDB170}" Type="string" />

                    <RegistryKey Key="InProcServer32">
                        <RegistryValue Value="[INSTALLDIR]wsldevicehost.dll" Type="string" />
                        <RegistryValue Name="ThreadingModel" Value="Both" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- WslDeviceHost WSLA_VIRTIO_FS_CLASS_ID -->
                <RegistryKey Root="HKCR" Key="CLSID\{06ED032F-C528-41C1-B75D-905EEE823BBA}">
                    <RegistryValue Value="WslDeviceHost_VirtioFs" Type="string" />
                    <RegistryValue Name="AppId" Value="{C457EA11-5486-4174-B90D-089909EDB170}" Type="string" />

                    <RegistryKey Key="InProcServer32">
                        <RegistryValue Value="[INSTALLDIR]wsldevicehost.dll" Type="string" />
                        <RegistryValue Name="ThreadingModel" Value="Both" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- WslDeviceHost WSLA_VIRTIO_NET_CLASS_ID -->
                <RegistryKey Root="HKCR" Key="CLSID\{7B3C9A42-8E1F-4D5A-9F2E-C4A7B8D3E6F1}">
                    <RegistryValue Value="WslDeviceHost_VirtioNet" Type="string" />
                    <RegistryValue Name="AppId" Value="{C457EA11-5486-4174-B90D-089909EDB170}" Type="string" />

                    <RegistryKey Key="InProcServer32">
                        <RegistryValue Value="[INSTALLDIR]wsldevicehost.dll" Type="string" />
                        <RegistryValue Name="ThreadingModel" Value="Both" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <!-- WslDeviceHost WSLA_VIRTIO_PMEM_CLASS_ID -->
                <RegistryKey Root="HKCR" Key="CLSID\{ABB755FC-1B86-4255-83E2-E5787ABCF6C2}">
                    <RegistryValue Value="WslDeviceHost_VirtioPmem" Type="string" />
                    <RegistryValue Name="AppId" Value="{C457EA11-5486-4174-B90D-089909EDB170}" Type="string" />

                    <RegistryKey Key="InProcServer32">
                        <RegistryValue Value="[INSTALLDIR]wsldevicehost.dll" Type="string" />
                        <RegistryValue Name="ThreadingModel" Value="Both" Type="string" />
                    </RegistryKey>
                </RegistryKey>

                <File Id="wslaservice.exe" Source="${BIN}/wslaservice.exe"  KeyPath="yes" />
                <File Id="wslaserviceproxystub.dll" Name="wslaserviceproxystub.dll" Source="${BIN}/wslaserviceproxystub.dll" />
                <File Id="wsladiag.exe" Name="wsladiag.exe" Source="${BIN}/wsladiag.exe" />

                <File Id="wsldevicehost.dll" Source="${BIN}/wsldevicehost.dll" />
                <File Id="wslrelay.exe" Name="wslrelay.exe" Source="${BIN}/wslrelay.exe" />

                <!-- Temporary runtime VHD. TODO: Update once the final VHD is available. -->
                <?if "${WSL_DEV_BINARY_PATH}" = "" AND "${TARGET_PLATFORM}" = "x64" ?>
                    <File Id="wslarootfs.vhd" Name="wslarootfs.vhd" Source="${WSLA_TEST_DISTRO_SOURCE_DIR}/rootfs.vhd"/>
                <?endif?>

                <ServiceInstall Name="WSLAService" DisplayName="WSLA Service" Description="WSLA Service" Start="auto" Type="ownProcess" ErrorControl="normal" Account="LocalSystem" Vital="yes" Interactive="no" />
                <ServiceControl Id="StopWSLAService" Stop="both" Remove="uninstall" Name="WSLAService" Wait="yes" />
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="TOOLSFOLDER">
            <Component Id="tools" Guid="AD5D2394-6344-4DAA-924B-CFA46175ECD6" Bitness="always64" UninstallWhenSuperseded="yes">
                <File Id="initrd.img" Source="${BIN}/initrd.img"/>

                <?if "${WSL_DEV_BINARY_PATH}" = "" ?>
                    <File Id="kernel" Source="${KERNEL_SOURCE_DIR}/bin/${TARGET_PLATFORM}/kernel"/>
                    <File Id="modules.vhd" Source="${KERNEL_SOURCE_DIR}/bin/${TARGET_PLATFORM}/modules.vhd"/>
                <?endif?>
            </Component>
        </DirectoryRef>

        <?if "${WSL_DEV_BINARY_PATH}" = "" ?>
            <DirectoryRef Id="LIBFOLDER">
                <Component Id="directx" Guid="5F20FE67-C8EE-434F-8FA6-E8DD073D05BA" Bitness="always64" UninstallWhenSuperseded="yes">
                    <!--
                    <File Id="libd3d12.so" Source="${DIRECT3D_SOURCE_DIR}/lib/${TARGET_PLATFORM}/libd3d12.so" />
                    <File Id="libd3d12core.so" Source="${DIRECT3D_SOURCE_DIR}/lib/${TARGET_PLATFORM}/libd3d12core.so" />
                    <File Id="libdxcore.so" Source="${DXCORE_SOURCE_DIR}/lib/libdxcore.so" />
                    -->
                </Component>
            </DirectoryRef>
        <?endif?>

        <Feature Id="WSLA" Title="WSL For Apps" Level="1">
            <ComponentRef Id="wslaservice" />
            <ComponentRef Id="tools" />

            <?if "${WSL_DEV_BINARY_PATH}" = "" ?>
                <ComponentRef Id="directx" />
            <?endif?>
        </Feature>

        <!-- Don't show a 'Modify' button in settings since there is nothing to modify -->
        <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />
        <Property Id="ARPSYSTEMCOMPONENT" Value="yes" Secure="yes" />

        <!-- Setting REINSTALLMODE to AMUS will force all re-installed components to re-install all files, registry keys and shortcuts.
        This is useful during downgrades since components with KeyPath set will not removed if their KeyPath points to valid file / registry key.
        -->
        <Property Id="REINSTALLMODE" Value="AMUS" Secure="yes" />

        <!-- Force all applications to exit during upgrade.
             See: https://learn.microsoft.com/en-us/windows/win32/msi/msirmshutdown
        -->
        <Property Id="MSIRMSHUTDOWN" Value="0" Secure="yes" />
    </Package>
</Wix>
